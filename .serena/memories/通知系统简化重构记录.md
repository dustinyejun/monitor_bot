# 通知系统简化重构记录

## 重构背景
2025-08-21 进行的通知系统架构简化，将数据库驱动的配置改为代码硬编码配置。

## 重构原因
1. **配置相对固定**: 通知模板和规则很少变更，数据库存储增加了不必要的复杂性
2. **提升性能**: 消除每次通知的数据库查询延迟
3. **简化部署**: 减少数据库迁移和初始化脚本的维护成本
4. **降低复杂度**: 减少模板管理API和相关服务的维护成本

## 架构变更

### 旧架构
```
代码定义默认配置 → 写入数据库表 → 运行时查询数据库 → 执行通知
```

### 新架构  
```
代码硬编码配置 → 直接执行通知
```

## 创建的新文件

### 1. 计划文档
- `docs/notification_system_simplification_plan.md` - 详细的重构计划

### 2. 硬编码配置
- `src/config/notification_config.py` - 通知模板和规则的硬编码配置
  - `NotificationTemplate` 数据类 - 模板配置结构
  - `NotificationRule` 数据类 - 规则配置结构
  - `NOTIFICATION_TEMPLATES` 字典 - 所有模板配置
  - `NOTIFICATION_RULES` 字典 - 所有规则配置
  - 辅助函数: `get_template()`, `get_rules_by_type()` 等
  - 配置验证函数: `validate_config()`

## 当前支持的通知类型

### Solana监控
- **模板**: `solana_transaction`
- **规则**: `solana_transaction_rule`  
- **触发条件**: SOL转账≥$0.01 | DEX交换 | 任何交易≥$1.0
- **限流**: 5分钟内最多20条

### Twitter监控
- **模板**: `twitter_ca_alert`
- **规则**: `twitter_ca_detection`
- **触发条件**: 推文包含CA地址
- **限流**: 5分钟内最多5条

## 待完成的工作

1. **修改NotificationService** - 移除数据库模板查询，使用硬编码配置
2. **修改NotificationEngine** - 移除数据库规则查询，使用硬编码配置  
3. **更新API路由** - 移除模板和规则管理接口
4. **清理数据库模型** - 移除不必要的表和迁移
5. **更新测试代码** - 修改相关测试

## 性能预期
- **查询减少**: 每次通知节省2次数据库查询
- **响应时间**: 通知处理延迟降低10-20ms
- **内存使用**: 模板和规则常驻内存，占用很少

## 配置管理
- **修改模板**: 直接修改 `src/config/notification_config.py`
- **部署更新**: 重启服务即可生效
- **版本控制**: 所有配置变更都有Git记录

## 权衡说明
- ✅ **获得**: 简化架构、提升性能、降低复杂度
- ❌ **失去**: 动态配置能力、运行时管理接口

对于当前项目来说，配置的稳定性比动态调整的灵活性更重要，因此这个权衡是合理的。