# 推特与Solana监控机器人 - 详细实现计划

## 总体规划
- **总开发时间**: 8-10个工作日
- **技术栈**: FastAPI + SQLAlchemy + APScheduler + PostgreSQL
- **架构模式**: 单进程架构，集成定时任务调度

## 阶段1: 项目基础搭建 (第1天)

### 1.1 环境准备 (2小时)
- [x] 创建项目目录结构
  ```bash
  src/{api,services,models,utils,config,schemas}
  tests/ docker/ migrations/ logs/ requirements/ scripts/
  ```
- [x] 创建依赖文件 requirements/base.txt 和 dev.txt
- [x] 创建环境配置模板 .env.example
- [x] 创建 .gitignore 文件

### 1.2 核心配置 (3小时)
- [x] 实现配置管理 (src/config/settings.py)
  - 环境变量管理
  - 数据库配置
  - API密钥配置
- [x] 实现数据库连接 (src/config/database.py)
  - SQLAlchemy引擎配置
  - 会话管理
  - 连接池设置
- [x] 实现日志系统 (src/utils/logger.py)
  - Loguru配置
  - 多级别日志输出
  - 文件日志轮转

### 1.3 开发环境测试 (1小时)
- [ ] 安装依赖包验证
- [ ] 配置文件测试
- [ ] 日志系统测试

## 阶段2: 数据模型设计 (第2天)

### 2.1 数据库模型设计 (4小时)
- [ ] 创建基础模型类 (src/models/base.py)
  ```python
  - TimestampMixin: 时间戳字段
  - 基础配置和工具方法
  ```

- [ ] 推特相关模型 (src/models/twitter.py)
  ```python
  - TwitterUser: 推特用户信息
    * id, username, display_name, twitter_id
    * followers_count, min_followers
    * keywords (JSON), is_active
    * created_at, updated_at
  
  - Tweet: 推文记录
    * id, tweet_id, user_id (外键)
    * content, ca_addresses (JSON)
    * is_processed, is_notified
    * tweet_url, created_at
  ```

- [ ] Solana相关模型 (src/models/solana.py)
  ```python
  - SolanaWallet: 钱包信息
    * id, address, alias
    * min_amount_usd, watch_tokens (JSON)
    * is_active, created_at, updated_at
  
  - SolanaTransaction: 交易记录
    * id, signature, wallet_id (外键)
    * transaction_type, token_address, token_symbol
    * amount, amount_usd
    * is_processed, is_notified
    * block_time, solscan_url, created_at
  ```

### 2.2 数据库迁移 (2小时)
- [ ] 配置Alembic
- [ ] 创建初始迁移文件
- [ ] 测试数据库创建和迁移

### 2.3 Pydantic模式定义 (2小时)
- [ ] 推特数据模式 (src/schemas/twitter.py)
  ```python
  - TwitterUserCreate, TwitterUserResponse
  - TweetResponse
  - 请求和响应数据验证
  ```
- [ ] Solana数据模式 (src/schemas/solana.py)
  ```python
  - SolanaWalletCreate, SolanaWalletResponse
  - SolanaTransactionResponse
  ```

## 阶段3: 推特监控服务 (第3-4天)

### 3.1 Twitter API客户端 (第3天上午 - 4小时)
- [ ] 实现Twitter API客户端 (src/services/twitter_client.py)
  ```python
  - TwitterClient类
    * Bearer Token认证
    * get_user_by_username(): 获取用户信息
    * get_user_tweets(): 获取用户推文
    * 错误处理和重试机制
    * API频率限制处理
  ```

### 3.2 推文内容分析 (第3天下午 - 4小时)
- [ ] 实现推特分析器 (src/services/twitter_analyzer.py)
  ```python
  - TwitterAnalyzer类
    * extract_ca_addresses(): CA地址提取
      - 支持多种格式: CA:, 合约地址:, Contract:
      - 正则表达式模式匹配
      - 地址格式验证 (32-44字符)
    * check_keywords_match(): 关键词匹配
    * _contains_exclude_keywords(): 排除词检查
    * 去重和过滤逻辑
  ```

### 3.3 推特监控任务 (第4天上午 - 4小时)
- [ ] 实现监控任务 (src/services/twitter_monitor.py)
  ```python
  - TwitterMonitorService类
    * check_twitter_updates(): 主监控逻辑
      - 获取活跃用户列表
      - 查询最新推文ID
      - 批量处理新推文
      - CA地址检测和存储
    * 数据库操作封装
    * 错误处理和日志记录
  ```

### 3.4 单元测试 (第4天下午 - 2小时)
- [ ] 测试Twitter API客户端
- [ ] 测试CA地址提取功能
- [ ] 测试关键词匹配功能

## 阶段4: Solana监控服务 (第5-7天)

### 4.1 Solana客户端实现 (第5天 - 6小时)
- [ ] 实现Solana RPC客户端 (src/services/solana_client.py)
  ```python
  - SolanaClient类
    * get_wallet_transactions(): 获取钱包交易
      - 分页查询签名列表
      - 获取交易详情
      - 过滤失败交易
    * get_token_info(): 获取代币信息
      - Jupiter API集成
      - 代币元数据查询
    * get_token_price(): 获取代币价格
      - 实时价格查询
      - 价格缓存机制
  ```

### 4.2 交易数据解析 (第6天 - 6小时)
- [ ] 实现交易分析器 (src/services/solana_analyzer.py)
  ```python
  - SolanaAnalyzer类
    * parse_transaction(): 交易解析主逻辑
      - 指令类型识别
      - 交易状态检查
    * _parse_token_transfer(): 代币转账解析
      - 源地址和目标地址
      - 转账金额和代币信息
    * _parse_swap(): 交换交易解析
      - DEX协议识别 (Raydium, Orca, Jupiter)
      - 交换对信息提取
    * 价值计算 (USD等值)
  ```

### 4.3 Solana监控任务 (第7天上午 - 4小时)
- [ ] 实现监控任务 (src/services/solana_monitor.py)
  ```python
  - SolanaMonitorService类
    * check_solana_wallets(): 主监控逻辑
      - 获取活跃钱包列表
      - 增量查询新交易
      - 交易解析和价值计算
      - 最小金额过滤
    * 数据持久化
    * 错误恢复机制
  ```

### 4.4 集成测试 (第7天下午 - 2小时)
- [ ] 测试Solana客户端连接
- [ ] 测试交易解析准确性
- [ ] 测试监控任务完整流程

## 阶段5: 通知推送服务 (第7天)

### 5.1 企业微信通知 (2小时)
- [ ] 实现通知服务 (src/services/notification_service.py)
  ```python
  - NotificationService类
    * send_twitter_notification(): 推特通知
      - 格式化推特消息模板
      - CA地址突出显示
      - 推文链接和用户信息
    * send_solana_notification(): Solana交易通知
      - 交易详情格式化
      - 代币信息和价值显示
      - Solscan链接
    * _send_message(): 微信API调用
    * 通知去重和频率控制
  ```

### 5.2 消息模板优化 (1小时)
- [ ] 设计消息模板
- [ ] 测试消息发送功能
- [ ] 错误处理和重试

## 阶段6: API接口开发 (第8天)

### 6.1 FastAPI应用搭建 (2小时)
- [ ] 创建主应用 (src/api/main.py)
  ```python
  - FastAPI应用初始化
  - 中间件配置 (CORS, 请求日志)
  - 异常处理器
  - 健康检查端点
  ```

### 6.2 路由实现 (4小时)
- [ ] 推特管理路由 (src/api/routers/twitter.py)
  ```python
  - GET /api/twitter/users: 获取用户列表
  - POST /api/twitter/users: 添加监控用户
  - PUT /api/twitter/users/{id}: 更新用户配置
  - DELETE /api/twitter/users/{id}: 删除用户
  - GET /api/twitter/users/{id}/tweets: 获取推文记录
  - POST /api/twitter/users/{id}/check: 手动触发检查
  ```

- [ ] Solana管理路由 (src/api/routers/solana.py)
  ```python
  - GET /api/solana/wallets: 获取钱包列表
  - POST /api/solana/wallets: 添加监控钱包
  - PUT /api/solana/wallets/{id}: 更新钱包配置
  - DELETE /api/solana/wallets/{id}: 删除钱包
  - GET /api/solana/wallets/{id}/transactions: 获取交易记录
  ```

### 6.3 系统管理API (2小时)
- [ ] 系统状态路由 (src/api/routers/system.py)
  ```python
  - GET /api/system/status: 系统状态
  - GET /api/system/stats: 统计信息
  - POST /api/system/tasks/start: 启动任务
  - POST /api/system/tasks/stop: 停止任务
  ```

## 阶段7: 定时任务调度 (第9天)

### 7.1 任务调度器实现 (4小时)
- [ ] 创建调度器 (src/scheduler/scheduler.py)
  ```python
  - TaskScheduler类
    * start_scheduler(): 启动调度器
      - Twitter监控任务 (60秒间隔)
      - Solana监控任务 (30秒间隔)
      - 数据清理任务 (每日凌晨)
    * shutdown(): 优雅关闭
    * 任务状态监控
    * 错误恢复机制
  ```

### 7.2 集成到FastAPI (2小时)
- [ ] 应用启动时初始化调度器
- [ ] 实现优雅关闭处理
- [ ] 添加任务状态API

### 7.3 监控和维护任务 (2小时)
- [ ] 数据清理任务 (src/services/maintenance.py)
  ```python
  - 清理过期推文记录
  - 清理过期交易记录  
  - 数据库性能优化
  - 日志文件清理
  ```

## 阶段8: 部署配置 (第10天)

### 8.1 Docker配置 (3小时)
- [ ] 创建Dockerfile
  ```dockerfile
  - Python 3.9基础镜像
  - 依赖安装和优化
  - 应用代码复制
  - 健康检查配置
  - 启动命令
  ```

- [ ] 创建docker-compose.yml
  ```yaml
  - web服务配置
  - PostgreSQL数据库
  - 网络和存储卷配置
  - 环境变量管理
  ```

### 8.2 生产环境配置 (2小时)
- [ ] 生产环境依赖 (requirements/production.txt)
- [ ] 环境变量模板
- [ ] 启动脚本 (scripts/start.sh)
- [ ] 健康检查脚本

### 8.3 部署测试 (1小时)
- [ ] 本地Docker测试
- [ ] 数据库连接测试
- [ ] API接口测试
- [ ] 定时任务测试

## 验收标准

### 功能验收
- [ ] Twitter用户监控正常运行
- [ ] CA地址识别准确率 >95%
- [ ] Solana交易监控实时性 <30秒
- [ ] 企业微信通知成功率 >99%
- [ ] API接口响应时间 <500ms
- [ ] 系统7x24小时稳定运行

### 性能验收
- [ ] 内存占用 <512MB
- [ ] CPU使用率 <20%
- [ ] 数据库查询优化
- [ ] 并发处理能力测试

### 安全验收
- [ ] API密钥安全存储
- [ ] 数据库连接加密
- [ ] 错误信息不泄露敏感数据
- [ ] 日志脱敏处理

## 风险控制措施

### 开发风险
- **API限流**: 实现指数退避重试
- **数据解析错误**: 完善异常处理
- **网络异常**: 连接池和超时设置
- **内存泄漏**: 定期资源清理

### 运维风险  
- **服务异常**: 健康检查和自动重启
- **数据丢失**: 定期备份策略
- **性能瓶颈**: 监控指标和告警
- **扩容需求**: 容器化部署支持

## 后续优化规划

### 短期优化 (2-4周)
- [ ] 添加Web管理界面
- [ ] 实现更多DEX协议支持
- [ ] 优化CA地址识别算法
- [ ] 添加移动端推送

### 中期优化 (1-3个月)
- [ ] 支持多个区块链网络
- [ ] 机器学习模型集成
- [ ] 高级数据分析功能  
- [ ] API限流和访问控制

### 长期规划 (3-6个月)
- [ ] 微服务架构迁移
- [ ] 分布式部署支持
- [ ] 实时流处理架构
- [ ] 商业化功能开发